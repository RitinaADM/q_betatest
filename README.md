# FastAPI Приложение с Гексагональной Архитектурой

🌐 **[English Version / Английская версия](README_EN.md)**

Современное FastAPI приложение, реализующее гексагональную архитектуру (порты и адаптеры) с сохранением данных в базе данных, внедрением зависимостей Dishka, комплексным тестированием и правильным разделением ответственности.

## 🏗️ Архитектура

Этот проект следует принципам **Гексагональной Архитектуры** с четким паттерном **Порты и Адаптеры**, обеспечивая:
- **Изоляцию домена**: Бизнес-логика полностью независима от внешних зависимостей
- **Инверсию зависимостей**: Домен определяет интерфейсы, инфраструктура их реализует
- **Тестируемость**: Легко мокировать и тестировать каждый слой независимо
- **Гибкость**: Можно менять базы данных, API или фреймворки без изменения бизнес-логики
- **Сопровождаемость**: Четкие границы и ответственность для каждого компонента

### Слои Гексагональной Архитектуры

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        ВХОДЯЩИЕ АДАПТЕРЫ                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │   FastAPI REST   │  │   Health Check   │  │   Будущее: CLI   │      │
│  │   Контроллеры    │  │   Контроллеры    │  │   GraphQL, gRPC  │      │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘      │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                             ┌─────────────┐
                             │ ВХОДЯЩИЕ    │
                             │ ПОРТЫ       │ ← Интерфейсные контракты
                             │ (Сервисы)   │   для случаев использования
                             └─────────────┘
                                   │
┌──────────────────────────────────────────────────────────────────────────┐
│                         СЛОЙ ПРИЛОЖЕНИЯ                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │   Сервис Item    │  │   DTO и Передача │  │   Исключения     │      │
│  │   (Случаи исп.)  │  │   Данных         │  │   Приложения     │      │
│  │   Бизнес-поток   │  │   Объекты        │  │   и Валидация    │      │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘      │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
┌──────────────────────────────────────────────────────────────────────────┐
│                           СЛОЙ ДОМЕНА                                   │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │   Сущность Item  │  │   Объекты-       │  │   Исключения     │      │
│  │   (Основные      │  │   Значения       │  │   Домена         │      │
│  │    Бизнес-       │  │   (Неизменяемые  │  │   и Правила      │      │
│  │    Правила)      │  │    Значения)     │  │                  │      │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘      │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
                             ┌─────────────┐
                             │ ИСХОДЯЩИЕ   │
                             │ ПОРТЫ       │ ← Интерфейсные контракты
                             │ (Репозиторий│   для внешних зависимостей
                             │  и Кэш)     │
                             └─────────────┘
                                   │
┌──────────────────────────────────────────────────────────────────────────┐
│                       ИСХОДЯЩИЕ АДАПТЕРЫ                                │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │   SQLAlchemy     │  │   Redis Кэш      │  │   Будущее: Event │      │
│  │   База Данных    │  │   Адаптер        │  │   Streaming,     │      │
│  │   Адаптер        │  │   (Подготовлен)  │  │   Внешние API    │      │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘      │
└──────────────────────────────────────────────────────────────────────────┘
                                   │
┌──────────────────────────────────────────────────────────────────────────┐
│                       ИНФРАСТРУКТУРА                                    │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │   Конфигурация   │  │   Dishka DI      │  │   Конфигурация   │      │
│  │   Базы Данных    │  │   Контейнер      │  │   и Настройки    │      │
│  │   и Модели       │  │   и Провайдеры   │  │   Управления     │      │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘      │
└──────────────────────────────────────────────────────────────────────────┘
```

## 🌟 Возможности

### Архитектура и Дизайн
- **Истинная Гексагональная Архитектура**: Порты и адаптеры с четкими границами
- **Инверсия Зависимостей**: Слой домена определяет интерфейсы, инфраструктура реализует
- **Принципы SOLID**: Единственная ответственность, открыт/закрыт, инверсия зависимостей
- **Чистый Код**: Разделение ответственности с тестируемыми компонентами

### Технические Возможности
- **Сохранение в Базе Данных**: SQLite с асинхронным SQLAlchemy 2.0 ORM
- **Продвинутое Внедрение Зависимостей**: Dishka DI контейнер с паттерном провайдера
- **Полная Асинхронная Поддержка**: Сквозная реализация async/await
- **Миграции Базы Данных**: Alembic для версионирования схем и управления
- **Типобезопасность**: Полные аннотации типов с Pydantic v2 моделями
- **Валидация Ввода**: Комплексная валидация с пользовательской обработкой ошибок
- **Документация API**: Автогенерируемая OpenAPI 3.0 документация с примерами
- **Мониторинг Здоровья**: Проверки здоровья системы и подключения к базе данных
- **Обработка Ошибок**: Специфичные для домена исключения с правильными HTTP ответами
- **Управление Конфигурацией**: Настройки на основе окружения с Pydantic Settings

### Тестирование и Качество
- **Комплексное Тестирование**: Модульные, интеграционные и API тесты с pytest
- **Изоляция Тестов**: Правильное мокирование и внедрение зависимостей для тестов
- **Покрытие Кода**: Отчеты о покрытии и анализ
- **Паттерн Фабрики**: Генерация тестовых данных с Factory Boy
- **Асинхронное Тестирование**: Полная поддержка асинхронных тестов с pytest-asyncio

## 📋 API Эндпоинты

### Здоровье и Информация
- `GET /` - Приветственное сообщение
- `GET /health` - Проверка здоровья с подключением к базе данных

### Управление Элементами
- `GET /items` - Получить все элементы
- `GET /items/{item_id}` - Получить элемент по ID
- `POST /items` - Создать новый элемент
- `PUT /items/{item_id}` - Обновить элемент
- `DELETE /items/{item_id}` - Удалить элемент
- `GET /items/search/{query}` - Поиск элементов по имени/описанию

## ⚙️ Настройка и Установка

### Предварительные требования
- Python 3.9 или выше
- Git

### 1. Клонирование и Навигация
```bash
cd path/to/your/project
```

### 2. Создание Виртуального Окружения

**Вариант A: Использование существующего conda окружения (рекомендуется для этого проекта)**
```bash
conda activate beta2
```

**Вариант B: Использование Python venv**
```bash
python -m venv venv
```

**Вариант C: Использование нового conda окружения**
```bash
conda create -n fastapi-hex python=3.9
conda activate fastapi-hex
```

### 3. Активация Виртуального Окружения

**В Windows (PowerShell):**
```powershell
venv\Scripts\Activate.ps1
```

**В Windows (Command Prompt):**
```cmd
venv\Scripts\activate.bat
```

**В macOS/Linux:**
```bash
source venv/bin/activate
```

**Если политика выполнения PowerShell ограничена:**
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
venv\Scripts\Activate.ps1
```

### 4. Установка Зависимостей
```bash
pip install -r requirements.txt
```

### 5. Инициализация Базы Данных

**Вариант A: Использование скрипта инициализации (рекомендуется)**
```bash
python init_db.py init --with-data
```

**Вариант B: Использование миграций Alembic**
```bash
alembic upgrade head
python init_db.py seed  # Опционально: добавить примеры данных
```

### 6. Запуск Приложения

**Режим разработки (с авто-перезагрузкой):**
```bash
python main.py
```

**Или используя uvicorn напрямую:**
```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

**Продуктивный режим:**
```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```

## 🔎 Управление Базой Данных

### Инициализация Базы Данных
```bash
python init_db.py init          # Создать только таблицы
python init_db.py init --with-data  # Создать таблицы и добавить примеры данных
```

### Сброс Базы Данных
```bash
python init_db.py reset         # Сбросить только таблицы
python init_db.py reset --with-data # Сбросить и добавить примеры данных
```

### Добавление Примеров Данных
```bash
python init_db.py seed
```

### Миграции Базы Данных
```bash
# Создать новую миграцию
alembic revision --autogenerate -m "Описание изменений"

# Применить миграции
alembic upgrade head

# Откат миграции
alembic downgrade -1
```

## 📋 Документация API

После запуска сервера, получите доступ к интерактивной документации:
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## 📜 Структура Проекта

Проект следует строгой гексагональной архитектуре с четким разделением слоев:

```
q_betatest/
├── src/
│   ├── domain/                           # 🏛️ СЛОЙ ДОМЕНА (Основная Бизнес-Логика)
│   │   ├── entities/
│   │   │   ├── item.py                      # Сущность Item с бизнес-правилами
│   │   │   └── value_objects.py             # Неизменяемые объекты-значения
│   │   ├── ports/                        # 🔌 ПОРТЫ (Интерфейсные Контракты)
│   │   │   ├── inbound/                     # Интерфейсы входящей стороны
│   │   │   │   └── services/
│   │   │   │       ├── __init__.py
│   │   │   │       └── item_service_port.py # Интерфейс сервиса (случаи исп.)
│   │   │   └── outbound/                    # Интерфейсы исходящей стороны
│   │   │       ├── repositories/
│   │   │       │   └── item_repository.py   # Интерфейс репозитория
│   │   │       └── cache/
│   │   │           └── item_cache_port.py   # Интерфейс кэша
│   │   └── exceptions.py                 # Специфичные для домена исключения
│   │
│   ├── application/                      # 🎯 СЛОЙ ПРИЛОЖЕНИЯ (Случаи Использования)
│   │   ├── services/
│   │   │   └── item_service.py              # Реализация сервиса (оркестрация)
│   │   ├── dtos/
│   │   │   └── item_dtos.py                 # Объекты Передачи Данных
│   │   └── exceptions.py                 # Исключения приложения
│   │
│   └── infrastructure/                   # 🔧 СЛОЙ ИНФРАСТРУКТУРЫ
│       ├── adapters/                     # 🔌 АДАПТЕРЫ (Реализации Внешних Интерфейсов)
│       │   ├── inbound/                     # REST API, CLI и т.д.
│       │   │   └── rest/
│       │   │       ├── item_controller.py   # FastAPI REST контроллеры
│       │   │       ├── health_controller.py # Эндпоинты проверки здоровья
│       │   │       └── exception_handlers.py # HTTP обработка ошибок
│       │   └── outbound/                    # База данных, Кэш, Внешние API
│       │       ├── database/
│       │       │   └── sql/
│       │       │       └── item_repository_adapter.py # Реализация SQLAlchemy
│       │       └── cache/
│       │           └── redis/               # Реализация Redis кэша (подготовлена)
│       ├── config/
│       │   └── settings.py                  # Конфигурация приложения
│       ├── database/
│       │   ├── config.py                    # Настройка подключения к БД
│       │   └── models.py                    # SQLAlchemy ORM модели
│       ├── di/
│       │   └── container.py                 # Dishka контейнер внедрения зависимостей
│       ├── logging/
│       │   ├── __init__.py
│       │   └── config.py                    # Конфигурация логирования
│       └── repositories/
│           └── item_repository_impl.py      # Устаревший репозиторий (мигрируется)
│
├── tests/                                # 🧪 КОМПЛЕКСНЫЙ НАБОР ТЕСТОВ
│   ├── unit/                                # Модульные тесты для изолированных компонентов
│   │   ├── test_item_repository.py             # Тесты слоя репозитория
│   │   ├── test_dishka_container.py            # Тесты DI контейнера
│   │   └── test_input_validation.py            # Тесты валидации ввода
│   ├── integration/                         # Интеграционные тесты
│   │   └── test_item_repository.py             # Тесты интеграции с БД
│   └── conftest.py                          # Конфигурация Pytest и фикстуры
│
├── alembic/                              # 📊 МИГРАЦИИ БАЗЫ ДАННЫХ
│   ├── versions/
│   │   └── 385f34aedcb2_initial_migration.py   # Миграции схемы базы данных
│   ├── env.py                               # Конфигурация окружения Alembic
│   └── README                               # Инструкции по миграции
│
├── main.py                               # 🚀 Точка входа приложения
├── init_db.py                            # 🗄️ Скрипт инициализации базы данных
├── debug_test.py                         # 🐛 Утилиты отладки
├── test_api.py                           # 🔍 Скрипт ручного тестирования API
├── alembic.ini                           # ⚙️ Конфигурация Alembic
├── pytest.ini                            # 🧪 Конфигурация Pytest
├── requirements.txt                       # 📦 Зависимости Python
└── README.md                             # 📖 Эта документация
```

### 🏗️ Объяснение Архитектуры

#### Слой Домена (Ядро)
- **Сущности**: Бизнес-объекты с идентичностью и жизненным циклом
- **Объекты-Значения**: Неизменяемые объекты, представляющие концепции
- **Порты**: Интерфейсные контракты, определяющие что домен нуждается (исходящие) и предоставляет (входящие)
- **Исключения**: Определения ошибок, специфичных для домена

#### Слой Приложения (Оркестрация)
- **Сервисы**: Реализуют входящие порты, оркеструют операции домена
- **DTO**: Объекты передачи данных для границ приложения
- **Исключения**: Обработка ошибок на уровне приложения

#### Слой Инфраструктуры (Технические Детали)
- **Входящие Адаптеры**: REST контроллеры, CLI обработчики, потребители сообщений
- **Исходящие Адаптеры**: Репозитории баз данных, реализации кэша, внешние API
- **Конфигурация**: Настройки, установка базы данных, внедрение зависимостей
- **Сквозные Задачи**: Логирование, мониторинг, безопасность

### 🔄 Поток Зависимостей
```
Входящие Адаптеры → Входящие Порты → Сервисы Приложения → Исходящие Порты → Исходящие Адаптеры
      ↓                ↓                   ↓                 ↓                ↓
  REST API      Интерфейс Сервиса    Логика Случая Исп.    Интерфейс      База Данных
   (FastAPI)    (item_service_port)   (ItemService)       Репозитория     (SQLAlchemy)
```

## 🧪 Тестирование

Гексагональная архитектура с внедрением зависимостей делает тестирование комплексным и сопровождаемым:

### Структура Тестов
- **Модульные Тесты**: Тестируют отдельные компоненты в изоляции с мокированными зависимостями
- **Интеграционные Тесты**: Тестируют реализации адаптеров против реальных внешних систем
- **API Тесты**: Сквозное тестирование через REST эндпоинты
- **Контрактные Тесты**: Проверяют, что адаптеры правильно реализуют интерфейсы портов

### Запуск Тестов

**Запустить все тесты:**
```bash
pytest
```

**Запустить с покрытием:**
```bash
pytest --cov=src --cov-report=html
```

**Запустить определенные категории тестов:**
```bash
# Только модульные тесты
pytest tests/unit/

# Только интеграционные тесты
pytest tests/integration/

# Асинхронные тесты с подробным выводом
pytest -v -s tests/
```

### Возможности Тестирования
- **Тестирование Dishka DI**: Правильное тестирование внедрения зависимостей с валидацией контейнера
- **Поддержка Асинхронных Тестов**: Полное тестирование async/await с pytest-asyncio
- **Тестирование Базы Данных**: В памяти SQLite для быстрых, изолированных тестов БД
- **Паттерн Фабрики**: Последовательная генерация тестовых данных с Factory Boy
- **Мокирование**: Стратегическое мокирование внешних зависимостей на границах портов

### Стратегия Тестирования
Архитектура позволяет тестирование на нескольких уровнях:
1. **Слой Домена**: Чистые модульные тесты без внешних зависимостей
2. **Слой Приложения**: Тесты сервисов с мокированными репозиториями
3. **Слой Адаптеров**: Интеграционные тесты с реальными внешними системами
4. **Сквозные**: Полные тесты приложения через REST API

### Ручное Тестирование API

**Создать элемент:**
```bash
curl -X POST "http://localhost:8000/items" \
     -H "Content-Type: application/json" \
     -d '{
       "name": "Игровой ноутбук",
       "description": "Высокопроизводительный ноутбук для игр",
       "price": 1299.99,
       "in_stock": true
     }'
```

**Получить все элементы:**
```bash
curl "http://localhost:8000/items"
```

**Получить элемент по ID:**
```bash
curl "http://localhost:8000/items/1"
```

**Обновить элемент:**
```bash
curl -X PUT "http://localhost:8000/items/1" \
     -H "Content-Type: application/json" \
     -d '{
       "name": "Обновленный игровой ноутбук",
       "price": 1199.99
     }'
```

**Поиск элементов:**
```bash
curl "http://localhost:8000/items/search/ноутбук"
```

**Удалить элемент:**
```bash
curl -X DELETE "http://localhost:8000/items/1"
```

## 🐛 Устранение неполадок

### Проблемы с Политикой Выполнения PowerShell
Если вы столкнулись с проблемами политики выполнения PowerShell в Windows:

1. **Временно изменить политику выполнения:**
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```

2. **Или использовать Command Prompt вместо этого:**
   ```cmd
   venv\Scripts\activate.bat
   ```

### Проблемы с Базой Данных

1. **Разрешения файла базы данных:**
   - Убедитесь, что приложение имеет права записи в директории проекта
   - Файл базы данных SQLite `items.db` будет создан автоматически

2. **Конфликты миграций:**
   ```bash
   # Сбросить базу данных и миграции
   python init_db.py reset
   alembic upgrade head
   ```

3. **Проблемы установки зависимостей:**
   - Используйте диапазоны версий в requirements.txt для избежания проблем компиляции
   - Убедитесь, что используете Python 3.9+ для совместимости

## 🎯 Преимущества Архитектуры

### 🏛️ Принципы Чистой Архитектуры
1. **Независимость Домена**: Основная бизнес-логика полностью изолирована от внешних зависимостей
2. **Инверсия Зависимостей**: Высокоуровневые модули не зависят от низкоуровневых модулей
3. **Разделение Интерфейсов**: Хорошо определенные, сфокусированные интерфейсы на архитектурных границах
4. **Единственная Ответственность**: Каждый слой и компонент имеет четкую, единственную цель

### 🔧 Технические Преимущества
1. **Тестируемость**: Легкое модульное тестирование с внедрением зависимостей и мокированием на границах портов
2. **Гибкость**: Замена баз данных, API или фреймворков без изменения бизнес-логики
3. **Сопровождаемость**: Четкое разделение делает код легким для понимания, изменения и расширения
4. **Масштабируемость**: Хорошо определенные границы позволяют горизонтальное и вертикальное масштабирование
5. **Технологическая Независимость**: Слой домена свободен от специфичного для фреймворка кода
6. **Параллельная Разработка**: Команды могут работать независимо над различными адаптерами

### 🚀 Возможности Современной Разработки
1. **Типобезопасность**: Полные аннотации типов предотвращают ошибки времени выполнения
2. **Асинхронная Производительность**: Неблокирующий I/O для высокой пропускной способности
3. **Внедрение Зависимостей**: Dishka обеспечивает DI корпоративного уровня с управлением жизненным циклом
4. **Управление Конфигурацией**: Конфигурация на основе окружения с валидацией
5. **Миграции Базы Данных**: Версионированные изменения схемы с поддержкой отката

## 🔮 Будущие Улучшения

### 🔐 Безопасность и Аутентификация
- [ ] Система аутентификации на основе JWT
- [ ] Контроль доступа на основе ролей (RBAC)
- [ ] Управление API ключами
- [ ] Ограничение скорости и дросселирование

### 📊 Производительность и Масштабирование
- [ ] Реализация слоя кэширования Redis
- [ ] Оптимизация пулинга подключений к базе данных
- [ ] Асинхронная обработка фоновых задач
- [ ] Горизонтальное масштабирование с балансировкой нагрузки

### 🗄️ Поддержка Баз Данных
- [ ] Реализация адаптера PostgreSQL
- [ ] Реализация адаптера MySQL
- [ ] Адаптер MongoDB для хранения документов
- [ ] Стратегии шардинга базы данных

### 🔍 Наблюдаемость
- [ ] Структурированное логирование с ID корреляции
- [ ] Сбор метрик Prometheus
- [ ] Распределенная трассировка с OpenTelemetry
- [ ] Улучшения проверки здоровья

### 🛠️ Опыт Разработки
- [ ] Контейнеризация Docker
- [ ] Манифесты развертывания Kubernetes
- [ ] CI/CD пайплайн с GitHub Actions
- [ ] Стратегия версионирования API
- [ ] Реализация адаптера GraphQL
- [ ] Событийно-ориентированная архитектура с очередями сообщений

### 🧪 Улучшения Тестирования
- [ ] Тестирование на основе свойств с Hypothesis
- [ ] Нагрузочное тестирование с Locust
- [ ] Контрактное тестирование между сервисами
- [ ] Мутационное тестирование для качества тестов

### 📚 Документация
- [ ] Записи Архитектурных Решений (ADR)
- [ ] Документация API с примерами
- [ ] Руководства по разработке и учебные материалы
- [ ] Руководство по развертыванию и эксплуатации